(function(e,r){$window=e(r);e.fn.waterflow=function(i){function k(){e.extend(a,i||{});a.parent_width=f.width();a.column=Math.floor(a.parent_width/(a.block_width+2*a.margin));a.side_margin=(a.parent_width-a.column*(a.block_width+2*a.margin))/2;d=f.children("."+a.block_class);a.block_count=d.length;n={width:a.block_width,margin:a.margin,"padding-top":a.margin};e("."+a.block_class).css(n);l=0;o=[];h=[];p="<div class='ablock'><a target='_blank' href='{2}'><img class='pic' src='{0}' /><p>{1}</p></a></div>";
j=false}function q(){a.block_count=d.length;for(var b,c=l;c<a.block_count;c++)if(c<a.column){e(d[c]).css({top:a.margin+"px",left:(a.block_width+2*a.margin)*(c%a.column)+a.side_margin+"px"}).animate({opacity:"show"},a.animate_duration);h[c]=e(d[c]).height()+a.margin}else{b=h.min_index();e(d[c]).css({top:h[b]+4*a.margin+"px",left:(a.block_width+2*a.margin)*b+a.side_margin+"px"}).animate({opacity:"show"},a.animate_duration);h[b]+=e(d[c]).height()+4*a.margin}l=c;f.height(h[h.max_index()])}function s(){j=
true;e("#loading").show();e.ajax({url:a.ajaxUrl,type:"post",data:a.ajaxParams,dataType:"json",success:function(b){e("#loading").hide();e.each(b,function(c){t(b[c].src,function(){f.append(p.template(b[c].src,b[c].desc,b[c].link));d.push(f.children(":last").css(n))})});q();j=false;a.ajaxCount--}})}var f=e(this),a={block_width:230,margin:3,block_class:"ablock",ajaxUrl:"",ajaxParams:{},ajaxCount:4,animate_duration:1E3},o,h,d,p,n,l,j;String.prototype.template=function(){var b=arguments;return this.replace(/\{(\d+)\}/g,
function(c,m){return b[m]})};Array.prototype.max_index=function(){for(var b=this[0],c=this.length,m=0,g=1;g<c;g++)if(this[g]>b){b=this[g];m=g}return m};Array.prototype.min_index=function(){for(var b=this[0],c=this.length,m=0,g=1;g<c;g++)if(this[g]<b){b=this[g];m=g}return m};r.onresize=function(){k();q()};r.onscroll=function(){if(Math.abs(document.body.clientHeight-document.documentElement.clientHeight)<=(document.documentElement.scrollTop||document.body.scrollTop))if(!j&&a.ajaxUrl!="")if(a.ajaxCount>
0)s();else{e("#loading").hide();e("#nomore").show()}};r.onload=function(){k();q()}};var t=function(){var i=[],k=null,q=function(){for(var f=0;f<i.length;f++)i[f].end?i.splice(f--,1):i[f]();!i.length&&s()},s=function(){clearInterval(k);k=null};return function(f,a,o,h){var d,p,n,l,j,b=new Image;b.src=f;if(b.complete){a.call(b);o&&o.call(b)}else{p=b.width;n=b.height;b.onerror=function(){h&&h.call(b);d.end=true;b=b.onload=b.onerror=null};d=function(){l=b.width;j=b.height;if(l!==p||j!==n||l*j>1024){a.call(b);
d.end=true}};d();b.onload=function(){!d.end&&d();o&&o.call(b);b=b.onload=b.onerror=null};if(!d.end){i.push(d);if(k===null)k=setInterval(q,40)}}}}()})(jQuery,window);
